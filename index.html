<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Транскрибация Аудио</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel CDN for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google GenAI SDK -->
    <script type="module">
        import { GoogleGenAI } from "https://esm.run/@google/genai";
        window.GoogleGenAI = GoogleGenAI;
    </script>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;

        // --- SERVICES ---
        const API_KEY_STORAGE = 'gemini-api-key';

        const getApiKey = () => localStorage.getItem(API_KEY_STORAGE);
        const saveApiKey = (key) => localStorage.setItem(API_KEY_STORAGE, key);
        const removeApiKey = () => localStorage.removeItem(API_KEY_STORAGE);

        const uploadFileService = async (file, apiKey) => {
            const ai = new window.GoogleGenAI({ apiKey });
            // The new SDK's fileManager expects the file object directly
            const result = await ai.files.upload({ file });
            // The result itself is the file object with metadata
            return result; 
        };

        const transcribeAudioFileService = async (file, apiKey) => {
            const ai = new window.GoogleGenAI({ apiKey });
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: [{
                    parts: [{
                        text: "Транскрибируй этот аудиофайл. Предоставь только текст без каких-либо дополнительных фраз или форматирования."
                    }, {
                        fileData: {
                            mimeType: file.mimeType,
                            fileUri: file.uri,
                        }
                    }]
                }]
            });
            return response.text;
        };
        
        const createLiveSession = (apiKey, callbacks, config) => {
            const ai = new window.GoogleGenAI({ apiKey });
            return ai.live.connect({
                model: 'gemini-2.5-flash-native-audio-preview-09-2025',
                callbacks,
                config,
            });
        };

        // --- COMPONENTS ---
        const ApiKeyInput = ({ onKeySubmit }) => {
            const [apiKey, setApiKey] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (apiKey.trim()) {
                    onKeySubmit(apiKey.trim());
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4">
                    <div className="w-full max-w-md bg-slate-800 p-8 rounded-xl shadow-lg border border-slate-700">
                        <h1 className="text-2xl font-bold text-center mb-2 text-slate-100">Введите ваш API ключ</h1>
                        <p className="text-center text-slate-400 mb-6">Ключ будет сохранен локально в вашем браузере.</p>
                        <form onSubmit={handleSubmit} className="flex flex-col">
                            <input
                                type="password"
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                className="bg-slate-900 border border-slate-600 rounded-lg p-3 mb-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Gemini API Key"
                            />
                            <button
                                type="submit"
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200"
                            >
                                Сохранить и продолжить
                            </button>
                        </form>
                         <p className="text-xs text-slate-500 text-center mt-4">
                            Получить ключ можно в <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">Google AI Studio</a>.
                        </p>
                    </div>
                </div>
            );
        };

        const ModeSelection = ({ onSelectMode, onResetKey }) => {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4">
                    <div className="w-full max-w-md text-center">
                         <h1 className="text-3xl font-bold text-slate-100 mb-6">Выберите режим</h1>
                         <div className="flex flex-col sm:flex-row gap-4 justify-center">
                            <button onClick={() => onSelectMode('file')} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200">
                                Загрузить файл
                            </button>
                            <button onClick={() => onSelectMode('live')} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200">
                                Использовать микрофон
                            </button>
                         </div>
                         <button onClick={onResetKey} className="text-slate-400 hover:text-red-400 mt-8 text-sm transition-colors duration-200">
                            Сбросить API ключ
                         </button>
                    </div>
                </div>
            );
        };
        
        const Loader = ({ message }) => (
            <div className="flex flex-col items-center justify-center space-y-4">
                <div className="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                <p className="text-lg text-slate-300">{message}</p>
            </div>
        );

        const TranscriptionResult = ({ text, onReset }) => {
            const [isCopied, setIsCopied] = React.useState(false);

            const handleCopy = () => {
                navigator.clipboard.writeText(text);
                setIsCopied(true);
                setTimeout(() => setIsCopied(false), 2000); // Reset after 2 seconds
            };
            
            return (
                <div className="w-full max-w-3xl mx-auto flex flex-col items-center space-y-4">
                    <h2 className="text-xl font-semibold text-slate-200">Результат транскрибации:</h2>
                    <div className="w-full bg-slate-800 border border-slate-700 rounded-lg p-4 h-full max-h-[60vh] overflow-y-auto text-slate-300 whitespace-pre-wrap">
                        {text}
                    </div>
                    <div className="flex space-x-4">
                        <button
                            onClick={onReset}
                            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center"
                        >
                            Начать заново
                        </button>
                         <button
                            onClick={handleCopy}
                            className={`${
                                isCopied
                                    ? 'bg-emerald-600'
                                    : 'bg-green-600 hover:bg-green-700'
                            } text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center min-w-[140px]`}
                            disabled={isCopied}
                        >
                            {isCopied ? 'Скопировано!' : 'Скопировать текст'}
                        </button>
                    </div>
                </div>
            );
        };
        
        const FileTranscriber = ({ apiKey, onBack }) => {
            const [file, setFile] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [loadingStep, setLoadingStep] = useState('');
            const [error, setError] = useState('');
            const [transcription, setTranscription] = useState('');
            const fileInputRef = useRef(null);
            
            const FILE_SIZE_LIMIT_MB = 200;
            const FILE_SIZE_LIMIT_BYTES = FILE_SIZE_LIMIT_MB * 1024 * 1024;

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    if (selectedFile.size > FILE_SIZE_LIMIT_BYTES) {
                        setError(`Файл слишком большой. Максимальный размер: ${FILE_SIZE_LIMIT_MB} МБ.`);
                        setFile(null);
                        return;
                    }
                    setError('');
                    setFile(selectedFile);
                }
            };
            
            const handleTranscribe = async () => {
                if (!file) {
                    setError('Пожалуйста, выберите файл.');
                    return;
                }
                
                setIsLoading(true);
                setError('');
                setTranscription('');

                try {
                    setLoadingStep('1/2: Загрузка файла на сервер...');
                    const uploadedFile = await uploadFileService(file, apiKey);

                    setLoadingStep('2/2: Транскрибация аудио...');
                    const result = await transcribeAudioFileService(uploadedFile, apiKey);
                    
                    setTranscription(result);
                } catch (err) {
                    console.error(err);
                    setError('Ошибка транскрибации: ' + (err.message || 'Неизвестная ошибка. Проверьте ключ API и консоль.'));
                } finally {
                    setIsLoading(false);
                    setLoadingStep('');
                }
            };
            
            const handleReset = () => {
                setFile(null);
                setTranscription('');
                setError('');
                if(fileInputRef.current) {
                    fileInputRef.current.value = '';
                }
            };
            
            if (transcription) {
                return <TranscriptionResult text={transcription} onReset={handleReset} />
            }

            return (
                 <div className="w-full max-w-2xl mx-auto flex flex-col items-center">
                    <button onClick={onBack} className="self-start mb-6 text-slate-400 hover:text-blue-400 transition-colors">
                        &larr; Назад к выбору
                    </button>
                    <div className="w-full bg-slate-800 p-8 rounded-xl shadow-lg border border-slate-700 text-center">
                       {isLoading ? (
                           <Loader message={loadingStep} />
                       ) : (
                           <>
                               <h2 className="text-2xl font-bold mb-4">Загрузка файла</h2>
                               <p className="text-slate-400 mb-6">Выберите аудиофайл для транскрибации (до {FILE_SIZE_LIMIT_MB} МБ)</p>
                               <input
                                   type="file"
                                   accept="audio/*"
                                   onChange={handleFileChange}
                                   ref={fileInputRef}
                                   className="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                               />
                               {file && <p className="mt-4 text-slate-300">Выбран файл: {file.name}</p>}
                               {error && <p className="mt-4 text-red-400">{error}</p>}
                               <button
                                   onClick={handleTranscribe}
                                   disabled={!file || isLoading}
                                   className="mt-6 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200"
                               >
                                   Транскрибировать
                               </button>
                           </>
                       )}
                    </div>
                 </div>
            );
        };

        const LiveTranscriber = ({ apiKey, onBack }) => {
            const [isRecording, setIsRecording] = useState(false);
            const [transcription, setTranscription] = useState('');
            const [error, setError] = useState('');
            
            const sessionRef = useRef(null);
            const audioContextRef = useRef(null);
            const processorRef = useRef(null);
            const streamRef = useRef(null);

            const startRecording = async () => {
                setError('');
                setTranscription('');
                setIsRecording(true);

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    streamRef.current = stream;
                    
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                    const source = audioContextRef.current.createMediaStreamSource(stream);
                    processorRef.current = audioContextRef.current.createScriptProcessor(4096, 1, 1);
                    
                    const sessionPromise = createLiveSession(apiKey, {
                        onopen: () => console.log("Live session opened."),
                        onmessage: (message) => {
                            if (message.serverContent?.outputTranscription) {
                                setTranscription(prev => prev + message.serverContent.outputTranscription.text);
                            }
                        },
                        onerror: (e) => {
                            console.error(e);
                            setError("Произошла ошибка соединения. Попробуйте еще раз.");
                            stopRecording();
                        },
                        onclose: () => console.log("Live session closed."),
                    }, {
                        outputAudioTranscription: {}
                    });

                    sessionRef.current = await sessionPromise;

                    processorRef.current.onaudioprocess = (audioProcessingEvent) => {
                        const inputData = audioProcessingEvent.inputBuffer.getChannelData(0);
                        const l = inputData.length;
                        const int16 = new Int16Array(l);
                        for (let i = 0; i < l; i++) {
                            int16[i] = inputData[i] * 32768;
                        }
                        const base64 = btoa(String.fromCharCode.apply(null, new Uint8Array(int16.buffer)));
                        if (sessionRef.current) {
                           sessionRef.current.sendRealtimeInput({ media: { data: base64, mimeType: 'audio/pcm;rate=16000' } });
                        }
                    };

                    source.connect(processorRef.current);
                    processorRef.current.connect(audioContextRef.current.destination);

                } catch (err) {
                    console.error(err);
                    setError('Не удалось получить доступ к микрофону. Проверьте разрешения в браузере.');
                    setIsRecording(false);
                }
            };
            
            const stopRecording = () => {
                setIsRecording(false);
                if (sessionRef.current) {
                    sessionRef.current.close();
                    sessionRef.current = null;
                }
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                    streamRef.current = null;
                }
                if (processorRef.current) {
                    processorRef.current.disconnect();
                    processorRef.current = null;
                }
                 if (audioContextRef.current && audioContextRef.current.state !== 'closed') {
                    audioContextRef.current.close();
                    audioContextRef.current = null;
                }
            };

            useEffect(() => {
                // Cleanup on component unmount
                return () => stopRecording();
            }, []);

            return (
                <div className="w-full max-w-3xl mx-auto flex flex-col items-center">
                     <button onClick={onBack} className="self-start mb-6 text-slate-400 hover:text-blue-400 transition-colors">
                        &larr; Назад к выбору
                    </button>
                    <div className="w-full bg-slate-800 p-8 rounded-xl shadow-lg border border-slate-700">
                        <div className="text-center mb-6">
                            <h2 className="text-2xl font-bold">Транскрибация с микрофона</h2>
                             <p className="text-slate-400 mt-2">Нажмите "Начать", чтобы транскрибировать речь в реальном времени.</p>
                        </div>
                        <div className="flex justify-center space-x-4 mb-6">
                             <button
                                onClick={startRecording}
                                disabled={isRecording}
                                className="bg-green-600 hover:bg-green-700 disabled:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                            >
                                Начать
                            </button>
                             <button
                                onClick={stopRecording}
                                disabled={!isRecording}
                                className="bg-red-600 hover:bg-red-700 disabled:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                            >
                                Стоп
                            </button>
                        </div>
                        {error && <p className="text-red-400 text-center mb-4">{error}</p>}
                        <div className="w-full bg-slate-900 border border-slate-700 rounded-lg p-4 min-h-[200px] text-slate-300 whitespace-pre-wrap">
                            {transcription || (isRecording ? "Слушаю..." : "Здесь появится транскрибация...")}
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- MAIN APP ---
        const App = () => {
            const [apiKey, setApiKey] = useState(getApiKey());
            const [mode, setMode] = useState(null); // 'file' or 'live'

            const handleKeySubmit = (key) => {
                saveApiKey(key);
                setApiKey(key);
            };

            const handleResetKey = () => {
                removeApiKey();
                setApiKey(null);
                setMode(null);
            };

            const handleBackToSelection = () => {
                setMode(null);
            };

            if (!apiKey) {
                return <ApiKeyInput onKeySubmit={handleKeySubmit} />;
            }

            return (
                 <div className="container mx-auto p-4 py-8">
                    {!mode ? (
                        <ModeSelection onSelectMode={setMode} onResetKey={handleResetKey} />
                    ) : mode === 'file' ? (
                        <FileTranscriber apiKey={apiKey} onBack={handleBackToSelection} />
                    ) : (
                        <LiveTranscriber apiKey={apiKey} onBack={handleBackToSelection} />
                    )}
                 </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
